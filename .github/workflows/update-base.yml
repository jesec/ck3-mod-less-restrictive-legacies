name: Update CK3 Mod Base

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version matches'
        required: false
        type: boolean
        default: false

  # Scheduled check (daily at 12:00 UTC)
  schedule:
    - cron: '0 12 * * *'

# Prevent concurrent runs
concurrency:
  group: ck3-update
  cancel-in-progress: false  # Let running job finish

# Required secrets:
# - STEAM_USERNAME: Your Steam username
# - STEAM_PASSWORD: Your Steam password
# - STEAM_TOTP_SECRET: Your Steam shared secret for TOTP generation

env:
  DEPOTDOWNLOADER_COMMIT: '007857c13fa3b32c30d20ee078dd6f1ea0075402'
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20.x'

jobs:
  update:
    # Only run on jesec/ck3-mod-base, not forks or other repos
    if: github.repository == 'jesec/ck3-mod-base'
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Prevent infinite hangs

    permissions:
      contents: write  # For pushing commits

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Only need latest commit

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.STEAM_USERNAME }}" ]; then
            echo "‚ùå STEAM_USERNAME secret is not set"
            echo "::error::STEAM_USERNAME secret must be configured in repository settings"
            exit 1
          fi
          if [ -z "${{ secrets.STEAM_PASSWORD }}" ]; then
            echo "‚ùå STEAM_PASSWORD secret is not set"
            echo "::error::STEAM_PASSWORD secret must be configured in repository settings"
            exit 1
          fi
          if [ -z "${{ secrets.STEAM_TOTP_SECRET }}" ]; then
            echo "‚ùå STEAM_TOTP_SECRET secret is not set"
            echo "::error::STEAM_TOTP_SECRET secret must be configured in repository settings"
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: base/scripts/automation/package-lock.json

      - name: Install Node dependencies
        run: npm ci
        working-directory: base/scripts/automation

      - name: Cache DepotDownloader binary
        id: cache-depot
        uses: actions/cache@v4
        with:
          path: /tmp/depotdownloader
          # Cache key includes both commit hash AND patch file hash
          key: depotdownloader-${{ env.DEPOTDOWNLOADER_COMMIT }}-${{ hashFiles('base/scripts/automation/depotdownloader.patch') }}

      - name: Build patched DepotDownloader
        if: steps.cache-depot.outputs.cache-hit != 'true'
        run: |
          set -e  # Exit on any error

          echo "üì¶ Cloning DepotDownloader at commit $DEPOTDOWNLOADER_COMMIT..."
          # Clone full repo to access specific commit (can't use --depth with old commits)
          git clone https://github.com/SteamRE/DepotDownloader.git /tmp/depot-repo
          cd /tmp/depot-repo

          echo "üîç Checking out specific commit..."
          git checkout $DEPOTDOWNLOADER_COMMIT

          echo "üîß Validating patch..."
          if ! git apply --check $GITHUB_WORKSPACE/base/scripts/automation/depotdownloader.patch 2>&1; then
            echo "‚ùå Patch failed validation!"
            echo "::error::Patch file does not apply cleanly to commit $DEPOTDOWNLOADER_COMMIT"
            git apply --check $GITHUB_WORKSPACE/base/scripts/automation/depotdownloader.patch || true
            exit 1
          fi

          echo "üîß Applying 2FA authentication patch..."
          git apply $GITHUB_WORKSPACE/base/scripts/automation/depotdownloader.patch

          echo "üèóÔ∏è  Building DepotDownloader..."
          dotnet publish DepotDownloader/DepotDownloader.csproj \
            --configuration Release \
            -p:PublishSingleFile=true \
            -p:DebugType=embedded \
            --self-contained \
            --runtime linux-x64 \
            --output /tmp/depotdownloader

          if [ ! -f /tmp/depotdownloader/DepotDownloader ]; then
            echo "‚ùå Build failed - binary not found"
            exit 1
          fi

          echo "‚úÖ DepotDownloader built successfully"
          ls -lh /tmp/depotdownloader/DepotDownloader

      - name: Add DepotDownloader to PATH
        run: |
          if [ ! -f /tmp/depotdownloader/DepotDownloader ]; then
            echo "‚ùå DepotDownloader binary not found (cache/build issue)"
            exit 1
          fi
          chmod +x /tmp/depotdownloader/DepotDownloader
          echo "/tmp/depotdownloader" >> $GITHUB_PATH

      - name: Check current version
        id: current
        run: |
          if [ -f base/.ck3-version.json ]; then
            CURRENT_VERSION=$(jq -r '.version' base/.ck3-version.json)
            if [ "$CURRENT_VERSION" = "null" ] || [ -z "$CURRENT_VERSION" ]; then
              echo "‚ö†Ô∏è  Invalid version in base/.ck3-version.json"
              CURRENT_VERSION="none"
            fi
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "üìã Current version: $CURRENT_VERSION"
          else
            echo "version=none" >> $GITHUB_OUTPUT
            echo "üìã No current version (first run)"
          fi

      - name: Check latest CK3 version
        id: latest
        run: |
          echo "üîç Fetching latest CK3 version from Steam..."
          LATEST_VERSION=$(node index.js check)

          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "‚ùå Failed to fetch latest CK3 version from Steam API"
            echo "::error::Steam API returned empty version"
            exit 1
          fi

          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "üìã Latest CK3 version: $LATEST_VERSION"
        working-directory: base/scripts/automation

      - name: Determine if update needed
        id: needs_update
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          FORCE="${{ github.event.inputs.force_update }}"

          if [ "$FORCE" = "true" ]; then
            echo "üîÑ Force update requested"
            echo "needed=true" >> $GITHUB_OUTPUT
          elif [ "$CURRENT" = "none" ]; then
            echo "‚ú® First run - downloading CK3 $LATEST"
            echo "needed=true" >> $GITHUB_OUTPUT
          elif [ "$CURRENT" != "$LATEST" ]; then
            echo "üÜï Update available: $CURRENT ‚Üí $LATEST"
            echo "needed=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Already up to date ($CURRENT)"
            echo "needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Free up disk space
        if: steps.needs_update.outputs.needed == 'true'
        run: |
          echo "üßπ Freeing up disk space..."
          echo "üìä Disk space before cleanup:"
          df -h

          # Remove large pre-installed packages to free up ~10-15GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

          echo "üìä Disk space after cleanup:"
          df -h

      - name: Download CK3 files
        if: steps.needs_update.outputs.needed == 'true'
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
          STEAM_TOTP_SECRET: ${{ secrets.STEAM_TOTP_SECRET }}
        run: |
          set -e
          VERSION="${{ steps.latest.outputs.version }}"
          DOWNLOAD_DIR="/tmp/ck3-download"
          AUTOMATION_DIR="$GITHUB_WORKSPACE/base/scripts/automation"

          echo "üì• Downloading CK3 $VERSION (Windows version)..."
          echo "   Using password + TOTP authentication"
          echo "   Download directory: $DOWNLOAD_DIR"
          echo "   Note: DepotDownloader always fetches latest live version"

          # Validate automation directory exists
          if [ ! -d "$AUTOMATION_DIR" ]; then
            echo "‚ùå Error: Automation directory not found: $AUTOMATION_DIR"
            exit 1
          fi

          # Credentials are passed via environment variables
          # Note: VERSION param is informational - DepotDownloader fetches latest
          cd "$AUTOMATION_DIR"
          node index.js download "$VERSION" "$DOWNLOAD_DIR"

          if [ ! -d "$DOWNLOAD_DIR" ]; then
            echo "‚ùå Download failed - directory not created"
            exit 1
          fi

          echo "‚úÖ Download successful"

      - name: Parse downloaded files
        if: steps.needs_update.outputs.needed == 'true'
        run: |
          set -e
          DOWNLOAD_DIR="/tmp/ck3-download"
          AUTOMATION_DIR="$GITHUB_WORKSPACE/base/scripts/automation"
          BASE_DIR="$GITHUB_WORKSPACE/base"
          RELEASE_NOTES_DIR="$BASE_DIR/release-notes"

          echo "üìä Parsing CK3 installation..."
          echo "   Download directory: $DOWNLOAD_DIR"
          echo "   Base directory: $BASE_DIR"
          echo "   Release notes directory: $RELEASE_NOTES_DIR"

          # Validate directories
          if [ ! -d "$DOWNLOAD_DIR" ]; then
            echo "‚ùå Error: Download directory not found: $DOWNLOAD_DIR"
            exit 1
          fi
          if [ ! -d "$AUTOMATION_DIR" ]; then
            echo "‚ùå Error: Automation directory not found: $AUTOMATION_DIR"
            exit 1
          fi

          cd "$AUTOMATION_DIR"
          node index.js parse "$DOWNLOAD_DIR" "$BASE_DIR" "$RELEASE_NOTES_DIR"

          if [ ! -f "$BASE_DIR/.ck3-version.json" ]; then
            echo "‚ùå Parse failed - $BASE_DIR/.ck3-version.json not created"
            exit 1
          fi

          echo "‚úÖ Parse complete"
          echo "   Metadata: $BASE_DIR/.ck3-version.json"
          echo "   Release notes: $RELEASE_NOTES_DIR/"

      - name: Extract game files
        if: steps.needs_update.outputs.needed == 'true'
        run: |
          set -e
          DOWNLOAD_DIR="/tmp/ck3-download"
          DOWNLOAD_GAME_DIR="$DOWNLOAD_DIR/game"
          AUTOMATION_DIR="$GITHUB_WORKSPACE/base/scripts/automation"
          GAME_DIR="$GITHUB_WORKSPACE/base/game"

          echo "üìÇ Extracting game files..."
          echo "   Source: $DOWNLOAD_GAME_DIR"
          echo "   Destination: $GAME_DIR"

          # Validate directories
          if [ ! -d "$DOWNLOAD_GAME_DIR" ]; then
            echo "‚ùå Error: Downloaded game directory not found: $DOWNLOAD_GAME_DIR"
            echo "Available directories in download:"
            ls -la "$DOWNLOAD_DIR" || true
            exit 1
          fi
          if [ ! -d "$AUTOMATION_DIR" ]; then
            echo "‚ùå Error: Automation directory not found: $AUTOMATION_DIR"
            exit 1
          fi

          # Remove old game directory to ensure clean extraction
          if [ -d "$GAME_DIR" ]; then
            echo "   Removing old game directory..."
            rm -rf "$GAME_DIR"
          fi

          cd "$AUTOMATION_DIR"
          # Extract from game/ subdirectory only, not launcher/ or other dirs
          node index.js extract "$DOWNLOAD_GAME_DIR" "$GAME_DIR"

          if [ ! -d "$GAME_DIR" ]; then
            echo "‚ùå Extraction failed - game directory not created: $GAME_DIR"
            exit 1
          fi

          echo "‚úÖ Extraction complete"
          echo "   Game files extracted to: $GAME_DIR/"

      - name: Check for changes
        if: steps.needs_update.outputs.needed == 'true'
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected:"
            git diff --cached --stat
          fi

      - name: Commit and push changes
        if: steps.needs_update.outputs.needed == 'true' && steps.changes.outputs.has_changes == 'true'
        run: |
          set -e
          VERSION="${{ steps.latest.outputs.version }}"
          VERSION_NAME=$(jq -r '.version_name // "Unknown"' base/.ck3-version.json)
          RELEASE_DATE=$(jq -r '.release_notes.date // ""' base/.ck3-version.json)

          git config user.name "CK3 Bot"
          git config user.email "bot@ck3.local"

          # Create commit message with proper newlines
          COMMIT_MSG="Version $VERSION ($VERSION_NAME)"$'\n\n'"Released $RELEASE_DATE"$'\n\n'"See release notes for details."

          git commit -m "$COMMIT_MSG"

          # Normalize version to x.x.x.x format for tagging
          IFS='.' read -r -a parts <<< "$VERSION"
          NORMALIZED_VERSION="${parts[0]:-0}.${parts[1]:-0}.${parts[2]:-0}.${parts[3]:-0}"
          MINOR_SERIES="${parts[0]:-0}.${parts[1]:-0}.${parts[2]:-0}"
          MAJOR_SERIES="${parts[0]:-0}.${parts[1]:-0}"
          REFRESH_SERIES="${parts[0]:-0}"

          echo "üè∑Ô∏è  Creating tags for version hierarchy..."
          # Exact version tag (patch level) - create if doesn't exist
          if git rev-parse "base/$NORMALIZED_VERSION" >/dev/null 2>&1; then
            echo "   Skipped: base/$NORMALIZED_VERSION (already exists)"
          else
            # Use -a for annotated tag, but handle case where tag was just created
            if git tag -a "base/$NORMALIZED_VERSION" -m "CK3 $VERSION ($VERSION_NAME)" 2>/dev/null; then
              echo "   Created: base/$NORMALIZED_VERSION (exact patch)"
            else
              echo "   Warning: Failed to create base/$NORMALIZED_VERSION (may already exist)"
            fi
          fi

          # Floating tags (force-update to point to latest in series)
          git tag -af "base/$MINOR_SERIES" -m "CK3 $VERSION ($VERSION_NAME) - latest patch in $MINOR_SERIES series"
          git tag -af "base/$MAJOR_SERIES" -m "CK3 $VERSION ($VERSION_NAME) - latest minor in $MAJOR_SERIES series"
          git tag -af "base/$REFRESH_SERIES" -m "CK3 $VERSION ($VERSION_NAME) - latest major in refresh $REFRESH_SERIES"

          echo "   Updated: base/$MINOR_SERIES (latest patch in minor)"
          echo "   Updated: base/$MAJOR_SERIES (latest minor in major)"
          echo "   Updated: base/$REFRESH_SERIES (latest major in refresh)"

          echo "üîÑ Pulling latest changes before push..."
          CURRENT_BRANCH=$(git branch --show-current)
          if [ -z "$CURRENT_BRANCH" ]; then
            echo "‚ùå Error: Detached HEAD state detected"
            echo "::error::Cannot push from detached HEAD - repository in unexpected state"
            exit 1
          fi

          git pull --rebase origin "$CURRENT_BRANCH" || {
            echo "‚ö†Ô∏è  Rebase conflict detected, using merge strategy"
            git pull --no-rebase origin "$CURRENT_BRANCH"
          }

          echo "‚¨ÜÔ∏è  Pushing changes and tags..."
          # Push commit and all version tags together (floating tags need --force)
          # Note: Can't use --atomic with --force on tags, so we do best-effort single command
          git push origin "$CURRENT_BRANCH" \
            "refs/tags/base/$NORMALIZED_VERSION" \
            "refs/tags/base/$MINOR_SERIES" \
            "refs/tags/base/$MAJOR_SERIES" \
            "refs/tags/base/$REFRESH_SERIES" \
            --force

          echo "‚úÖ Changes committed and pushed: $VERSION"
          echo "‚úÖ Tagged: base/$NORMALIZED_VERSION, base/$MINOR_SERIES, base/$MAJOR_SERIES, base/$REFRESH_SERIES"

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/depot-repo /tmp/ck3-download
          echo "üßπ Cleanup complete"

      - name: Summary
        if: always()
        run: |
          echo "## CK3 Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current version**: ${{ steps.current.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest version**: ${{ steps.latest.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update needed**: ${{ steps.needs_update.outputs.needed }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.needs_update.outputs.needed }}" = "true" ]; then
            if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
              VERSION="${{ steps.latest.outputs.version }}"
              IFS='.' read -r -a parts <<< "$VERSION"
              NORMALIZED_VERSION="${parts[0]:-0}.${parts[1]:-0}.${parts[2]:-0}.${parts[3]:-0}"
              MINOR_SERIES="${parts[0]:-0}.${parts[1]:-0}.${parts[2]:-0}"
              MAJOR_SERIES="${parts[0]:-0}.${parts[1]:-0}"
              REFRESH_SERIES="${parts[0]:-0}"

              echo "- **Result**: ‚úÖ Updated to $VERSION" >> $GITHUB_STEP_SUMMARY
              echo "- **Tags**: \`base/$NORMALIZED_VERSION\`, \`base/$MINOR_SERIES\`, \`base/$MAJOR_SERIES\`, \`base/$REFRESH_SERIES\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Result**: ‚ÑπÔ∏è No file changes" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Result**: ‚úÖ Already up to date" >> $GITHUB_STEP_SUMMARY
          fi
